self.addEventListener("install",()=>{self.skipWaiting()});self.addEventListener("activate",t=>{t.waitUntil(self.clients.claim())});const d=new Map;self.onmessage=t=>{if(t.data==="ping")return;const e=t.data,a=e.url||self.registration.scope+Math.random()+"/"+(typeof e=="string"?e:e.filename),s=t.ports[0],n=new Array(3);n[1]=e,n[2]=s,t.data.readableStream?n[0]=t.data.readableStream:t.data.transferringReadable?s.onmessage=c=>{s.onmessage=null,n[0]=c.data.readableStream}:n[0]=l(s),d.set(a,n),s.postMessage({download:a})};function l(t){return new ReadableStream({start(e){t.onmessage=({data:a})=>{if(a==="end")return e.close();if(a==="abort"){e.error("Aborted the download");return}e.enqueue(a)}},cancel(e){console.log("user aborted",e),t.postMessage({abort:!0})}})}self.onfetch=t=>{const e=t.request.url;if(e.endsWith("/ping"))return t.respondWith(new Response("pong"));const a=d.get(e);if(!a)return null;const[s,n,c]=a;d.delete(e);const o=new Headers({"Content-Type":"application/octet-stream; charset=utf-8","Content-Security-Policy":"default-src 'none'","X-Content-Security-Policy":"default-src 'none'","X-WebKit-CSP":"default-src 'none'","X-XSS-Protection":"1; mode=block"});let r=new Headers(n.headers||{});r.has("Content-Length")&&o.set("Content-Length",r.get("Content-Length")),r.has("Content-Disposition")&&o.set("Content-Disposition",r.get("Content-Disposition")),n.size&&(console.warn("Depricated"),o.set("Content-Length",n.size));let i=typeof n=="string"?n:n.filename;i&&(console.warn("Depricated"),i=encodeURIComponent(i).replace(/['()]/g,escape).replace(/\*/g,"%2A"),o.set("Content-Disposition","attachment; filename*=UTF-8''"+i)),t.respondWith(new Response(s,{headers:o})),c.postMessage({debug:"Download started"})};chrome.action.onClicked.addListener(t=>{chrome&&chrome.tabs&&chrome.tabs.query({active:!0,currentWindow:!0},function(e){e&&chrome.tabs.sendMessage(e[0].id,{message:"INJECT_DIALOG"},()=>{})})});chrome.tabs.onUpdated.addListener(function(t,e,a){chrome&&chrome.tabs&&chrome.tabs.query({active:!0,currentWindow:!0},function(s){s&&chrome.tabs.sendMessage(s[0].id,{message:"INJECT_BUTTON"},()=>{})})});
